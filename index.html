<!DOCTYPE html>
<html ng-app="trello-habitica" lang="en">
<head>
  <meta charset="utf-8">
  <title ng-bind="pageTitle">
    Trello-Habitica Integration
  </title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>
  <script src="https://api.trello.com/1/client.js?key=db4d00b345825701459f10a434629501"></script>
</head>
<body ng-class="">
<header>
  <h4>Trello-Habitica Integration</h4>
  <br/>
</header>

<div ng-controller="IntegrationController as ctrl">
  <label> Habitica ID:
    <input ng-model="ctrl.data.habitica.id" type="text"/>
  </label>
  <label> Habitica API token:
    <input ng-model="ctrl.data.habitica.token" type="text"/>
  </label>

  <h4>Create integration:</h4>
  <form>

    <label> Trello token:
      <input id="trello-token" type="text"/>
      <input id="trello-login-btn" type="button" value="Login with Trello"/>
    </label>

    <br/>

    <label> Trello username: </label>
    <input id="trello-username" type="text" disabled>
    
    Trello Boards:
    <div id="trello-boards">
    </div>
    
    Trello Lists:
    <div id="trello-lists">
    </div>

    <br/>

    <input type="submit" class="btn btn-primary" value="create"/>
  </form>
</div>

<footer>
</footer>

<script>
  config = {
    habitica: {
      id: '',
      token: ''
    },
    trello: {
      token: '',
      member: {
        id: '',
        fullName: '',
        username: '',
        boards: [{
          name: '',
          closed: false,
          id: '',
          lists: [{
            id: '',
            name: ''
          }]
        }]
      },
      using: {
        board: null,
        entryLists: [],
        exitLists: []
      }
    }
  };

  updateTrelloBoards = function () {
    var boards = config.trello.member.boards;

    $('#trello-boards').html('');

    if (boards && boards.length) {
      boards.forEach( function (b, i) {
        $("#trello-boards").append($('<input/>', {
          type: 'button',  
          id:'trello-board-' + i, 
          value: b.name,
          click: function () {
            config.trello.using.board = config.trello.member.boards[i].id;

            // TODO -> Get lists of board
            var lists = config.trello.member.boards[i].lists;
            if (!lists || !lists.length) {
              window.Trello.boards.get(config.trello.using.board, {
                fields: 'lists',
                lists: 'open'
              }, function (res) {
                config.trello.member.boards[i].lists = res.lists;
                updateTrelloList();
              });
            } else {
              updateTrelloList();
            }
          }
        }));
      });
    } else {
      config.trello.using.board = '';
      updateTrelloList();
    }
  };

  updateTrelloList = function () {
    var board = config.trello.member.boards.find(function (b) {
      return b.id === config.trello.using.board;
    });

    $('#trello-lists').html('');

    if (board && board.lists && board.lists.length) {
      board.lists.forEach( function (l, i) {
        $("#trello-lists").append($('<input/>', {
          type: 'button',
          id: 'trello-list-' + i,
          value: l.name
        }));
      });
    }
  };
  
  authSuccess = function () {
    config.trello.token = window.Trello.token();
    $('#trello-token').val(config.trello.token);

    window.Trello.members.get('me', {
      fields: 'id,fullName,username',
      boards: 'all'
    }, function (res) {
      config.trello.member = res;
      $('#trello-username').val(config.trello.member.username);
      updateTrelloBoards();
    });
  };

  authFail = function () {
    config.trello.token = '';
    config.trello.member = {};
    $('#trello-token').val(config.trello.token);
    $('#trello-username').val('');
    updateTrelloBoards();
  };

  $('#trello-login-btn').click(function () {
    window.Trello.authorize({
      type: 'popup',
      name: 'Habitica-Trello Integration',
      persist: false,
      scope: {
        read: true,
        write: true,
        account: false
      },
      expiration: 'never',
      success: authSuccess,
      error: authFail
    });
  });
</script>
</body>