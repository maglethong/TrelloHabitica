<!DOCTYPE html>
<html ng-app="trello-habitica" lang="en">
<head>
  <meta charset="utf-8">
  <title ng-bind="pageTitle">
    Trello-Habitica Integration
  </title>
  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>
  <script src="https://api.trello.com/1/client.js?key=db4d00b345825701459f10a434629501"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" 
          integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" 
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" 
          integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" 
          crossorigin="anonymous"></script>
  
  <link rel="stylesheet" 
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" 
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" 
        crossorigin="anonymous">
  
  <style>
    .habitica-header {
      background-color: #432874;
    }
    .habitica {
      color: #ffffff;
      background-color: #5d3b9c;
    }
    .habitica-logo {
      width: 128px;
      height: 28px;
    }
    .trello-header {
      background-color: rgb(0, 103, 163);
    }
    .trello {
      color: #ffffff;
      background-color: rgb(0, 121, 191);
    }
    .trello-logo {
      
    }
    .trello-board-collection {
    }
    .trello-board {
      background-color: rgb(224, 239, 247);
      border-color: rgb(0, 121, 191);
    }
    .trello-board.selected {
      background-color: rgb(199, 225, 241);
    }
    .trello-list-collection {
      margin-left: 4px;
      margin-right: 4px;
      margin-bottom: 15px;
    }
    .trello-list {
      
    }
    .trello-list-btn {
      background-color: rgb(224, 239, 247);
      border-color: rgb(0, 121, 191);
    }
    .trello-list-btn-in {

    }
    .trello-list-btn-out {

    }
    .trello-list-btn.selected {
      background-color: rgb(199, 225, 241);
    }
  </style>
</head>
<body class="bg-light">

<header>
  <div class="row" style="background-color: red; color: lime;">
    <div class="col">
      <h4 style="text-align: center"> This is a Work In Progress... The integration does not yet work and no data entered here is saved. </h4>
    </div>
  </div>
</header>

<div class="container py-3">

  <div class="row">
    <div class="mx-auto col-sm-9">
      <!-- Habitica Info -->
      <div class="card rounded-0 habitica">
        <div class="card-header habitica-header">
          <svg class="habitica-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 28">
            <g fill="none" fill-rule="evenodd">
              <path fill="#FFF" d="M24.052 26.3c-.832-.09-.841-.462-.832-5.421 0 0-.083-.312.395-.582.477-.27 1.93-2.679 1.037-4.734-.892-2.056-.248-1.952.125-1.744.374.208.554-.055.332-1.183-.457-2.325-1.17-3.113-2.851-4.162-1.104-.69-.704-1.94.866-1.848.766.045.766.046.862-.555.152-.947-.15-2.565-1.327-2.788-.81-.154-1.817.713-3.015.109-1.198-.604-3.178.904-3.988 1.254s-1.479.354-2.403.331c-.925-.022.49 1.531 1.906 1.881 1.216.3.743.516.674 1.51-.078 1.113.24 1.59-.279 1.707-.796.178-1.686-1.961-3.052-2.857C9.4 5.183 7.56 6.152 2.15.201c-.939-1.031-.558 2.159.02 3.862 1.543 4.55 4.532 5.153 5.942 5.29 1.18.116 1.984-.158 1.984.297 0 .33-1.391.48-1.93.482a9.469 9.469 0 0 1-1.762-.173c-1.073-.2.569 2.535 1.624 3.402 1.78 1.465 3.818 2.014 5.456 2.18.473.048 1.146.04 1.146.41 0 .352-.354.438-.773.441-2.294.017-3.612 1.849-3.986 3.967-.237 1.346-.06 2.868-.035 4.005l.09.812c.18 1.426-4.948 1.975-5.627-.322-.743-2.51 3.309-3.837 3.383-6.232.047-1.509-1.333-2.194-1.333-2.194v-2.204H4.76v-1.587H3.174V11.05H1.587v4.761h1.587V17.4h2.613c.594 0 1.07.392 1.015 1.24-.137 2.093-4.589 3.379-3.365 6.716.884 2.41 4.696 2.441 8.513 2.441l7.118-.006c.222 0 .534-.107.08-1.255-.367-.927-1.632-.276-2.706-.276-1.137 0-1.176-.96-.446-1.973.446-.618 1.014-1.078 1.979-1.527 1.486-.693 2.617.198 3.174.963.8 1.099 1.054 2.355.348 2.552-.851.238-1.113.27-1.141 1.08-.022.581.256.422 1.595.422h4.445c.688 0 .637-.53-.055-1.45-.491-.653-1.028.11-2.289-.027z"></path>
              <path fill="#FFF" d="M0 10.827h1.587V9.24H0zm113.986 9.067a1.385 1.385 0 0 0-1.942.25 2.804 2.804 0 0 1-2.236 1.101 2.82 2.82 0 0 1-2.815-2.645 416.05 416.05 0 0 1-.005-1.947 2.824 2.824 0 0 1 2.82-2.821c.781 0 1.508.312 2.046.879a1.385 1.385 0 0 0 2.008-1.907 5.614 5.614 0 0 0-4.054-1.741 5.596 5.596 0 0 0-5.59 5.59c0 .019.001 1.937.009 2.078a5.589 5.589 0 0 0 5.581 5.283 5.553 5.553 0 0 0 4.429-2.178 1.385 1.385 0 0 0-.251-1.942m8.237 1.351a2.819 2.819 0 0 1-2.815-2.644 419.52 419.52 0 0 1-.006-1.949 2.824 2.824 0 0 1 2.82-2.82 2.824 2.824 0 0 1 2.821 2.82c0 .2-.002 1.734-.005 1.946a2.818 2.818 0 0 1-2.815 2.647m4.205-10.422c-.645 0-1.183.444-1.336 1.04a5.55 5.55 0 0 0-2.87-.8 5.596 5.596 0 0 0-5.589 5.59c0 .019.001 1.936.008 2.078a5.589 5.589 0 0 0 8.517 4.447 1.384 1.384 0 0 0 2.655-.548V12.208c0-.765-.62-1.385-1.385-1.385M58.861 21.245a2.819 2.819 0 0 1-2.815-2.646c-.003-.213-.005-1.747-.005-1.947a2.824 2.824 0 0 1 2.82-2.82 2.824 2.824 0 0 1 2.82 2.82c0 .2-.001 1.734-.005 1.946a2.818 2.818 0 0 1-2.815 2.647m4.206-10.422c-.646 0-1.183.444-1.337 1.04a5.55 5.55 0 0 0-2.869-.8 5.596 5.596 0 0 0-5.59 5.59c0 .019.001 1.937.009 2.078a5.589 5.589 0 0 0 8.516 4.447 1.384 1.384 0 0 0 2.655-.548V12.208c0-.765-.62-1.385-1.384-1.385m20.384 0c-.764 0-1.384.62-1.384 1.385V22.63a1.385 1.385 0 0 0 2.769 0V12.208c0-.765-.62-1.385-1.385-1.385m16.308 0c-.765 0-1.385.62-1.385 1.385V22.63a1.385 1.385 0 0 0 2.77 0V12.208c0-.765-.62-1.385-1.385-1.385M76.266 18.6a2.82 2.82 0 0 1-2.815 2.645 2.82 2.82 0 0 1-2.815-2.647c-.004-.214-.005-1.746-.005-1.946a2.824 2.824 0 0 1 2.82-2.82 2.824 2.824 0 0 1 2.82 2.82c0 .193-.002 1.733-.005 1.949m-2.815-7.538c-1.03 0-1.991.284-2.82.772v-5.17a1.385 1.385 0 0 0-2.77 0V22.63a1.385 1.385 0 0 0 2.655.548c.856.529 1.86.836 2.935.836a5.59 5.59 0 0 0 5.582-5.288c.007-.137.008-2.054.008-2.074a5.596 5.596 0 0 0-5.59-5.59m-27.787.001a5.58 5.58 0 0 0-2.674.677V6.665a1.385 1.385 0 0 0-2.77 0V22.63a1.385 1.385 0 1 0 2.77 0v-7.157c.106-.09.203-.191.281-.315a2.808 2.808 0 0 1 2.393-1.326 2.824 2.824 0 0 1 2.82 2.82c0 .254-.002 5.635-.006 5.944a1.385 1.385 0 0 0 2.767.104c.007-.137.008-5.989.008-6.048a5.596 5.596 0 0 0-5.59-5.59m48.84-.239h-1.616V6.665a1.385 1.385 0 0 0-2.77 0v4.158h-1.614a1.385 1.385 0 0 0 0 2.77h1.615v9.037a1.385 1.385 0 0 0 2.77 0v-9.038h1.615a1.385 1.385 0 0 0 0-2.769" mask="url(#b)"></path>
              <path fill="#FF6066" d="M84.785 6.665a1.385 1.385 0 1 1-2.77 0 1.385 1.385 0 0 1 2.77 0" mask="url(#b)"></path>
              <path fill="#4FB5E8" d="M101.092 6.665a1.385 1.385 0 1 1-2.77 0 1.385 1.385 0 0 1 2.77 0" mask="url(#b)">
            </path>
            </g>
          </svg>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6">
              <label>User ID</label>
              <input id="habitica-id" class="form-control rounded-0" type="text">
              <div class="help-block with-errors"></div>
            </div>
            <div class="col-sm-6">
              <label>API Token</label>
              <input id="habitica-token" class="form-control rounded-0" type="password">
            </div>
          </div>
        </div>
      </div>
      <br/>
      <!-- Trello Info -->
      <div class="card rounded-0 trello">
        <div class="card-header trello-header">
          <div class="row align-items-center">
            <div class="col">
              <img class="trello-logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAeCAMAAACMnWmDAAACOlBMVEX///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9Oi5STAAAAvXRSTlMAHOMEArYG5/j3CvsDDPb6KNv+JAGqjbH9/Mx79PNK4SnNX4M9xjdd+WCYFNKhy1YYtX9ZkdzxQ3XQSQ5zIBvqKjC45cUsHqmcDXRhEbymD6JaZegFTKyllZnYeIDaI/Xe68fp0zziCXInJS5Fl+2CiNQdIu6EjESLwHarVGbROKTCyXlizrKabyGoE7TshY4ZuVh+T2RVGvJ3o8o/sCtXRr4m4FsQQq0Iv9Xfa9Y0uzbXkjGTY0c7OcgXQTLmT9zPAAACwElEQVR4Xu3URW9cSRRA4dPudpOZOUZmhjDzBJkZJjzMzMzMzMxw/tvotWwpT5amFWk2I+Xb3N1Z1K0qrsI19x2pac+H9ROpA/wnmtUIi6q1lqsRW7x02WnmalNXQqU6Rci8HENy5hE4X9e5YeHlNX1JteGWOGHEajXZxNkubY4SEvTCRQK1XulxwnhF3Q9Pa9E5wjQ3ApFcHZ6ZBNaaUXLny20nNy2PELZgiQ7kM18dIQyNANw4MyNKxk0dI2onV+ruy1tRFQEua9cq8m/Q6R2wbrRlI7PQOXPGdTpQDptjZFC+xUAurE5pHWzTvGWwtFFvPpc9WFaqv8IeE70QmV9GpdZv0j7o13ujpBP6LAw1qlZFswZv15XAmHYP9dfoMa3vuEv3UFytbTClp9Kka7XnoNa/XrT91n8Lxo/qTuAOffSiGUXv36Z5H/Kk3g8FR/VueE7boxUGjteFQ+GlvKhfxWBjnoHmewp14dmLWsf1pSZfgyl9AIqLTJXxoPaMFpOhoeszrLMr8SGgRbV+W/nD+siicX0MenQvRHN0PizXA8QnLCyYu5RZBDbn6RNAlbqvGEp09IhWxHiq0Joy2KrT0KTPpBnUXWQJDuo0UJDSkufhpHYl9IU4O/ZqBfCFboWXtBXadTBbsF8vAa/q4UPAGwbejLP4LfVtgoM8Hod39F3e04Y0EF5GOBhbopPAB7oe4IyaOgOTCfUj+LhBx4iu1cL8T1bopblvORzs0JoCaNHtUYBPtaSJaGu16md0l6qd+RVq4edbtLGAWTgHwIieAE7pGIF4o4nzG77Uwxd01/5M9+thndBvNPlt1u/rgn4HjOv3ZEw2GDjWdPoH1WRrkeq+yI9qamf2D3bVgJXATyd+ZsbqyoTjv8Sgd3fSg7/x+x9a9Sf8tWb332QHQ+WEwToyWHAoBhDp5f/gmn8Ard3CvkoCRlIAAAAASUVORK5CYII=" />
            </div>
            <div class="col" align="right">
              <input id="trello-login-btn" class="btn btn-success btn rounded-0" type="button" value="Login"/>
              <img id="trello-username" srv=""> </img>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label>Choose a Board</label>
              <select id="trello-boards" class="form-control selectpicker custom-select btn-md show-tick trello-board-collection rounded-0">
              </select>
            </div>
          </div>
          <br/>

          <div class="row">
            <div class="col-md-6" data-toggle="tooltip" title="Cards created or moved here will create cards in Habitica">
              <label>Choose Create Lists</label>
              <select id="trello-lists-in" class="form-control selectpicker custom-select btn-md show-tick trello-board-collection rounded-0" multiple>
              </select>
            </div>
            <div class="col-md-6" data-toggle="tooltip" title="Cards moved here will complete cards in Habitica">
              <label>Choose Done Lists</label>
              <select id="trello-lists-out" class="form-control selectpicker custom-select btn-md show-tick trello-board-collection rounded-0" multiple>
              </select>
            </div>
          </div>

          
          
        </div>
      </div>
      <br/>
      <!-- Confirm -->
      <div style="margin-left: 12px; margin-right: 12px;">
        <input id="remove-btn" class="btn btn-lg btn-danger rounded-0" type="button" value="Remove"/>
          <input id="create-btn" class="btn btn-lg btn-success rounded-0 float-right" type="button" value="Create" />
      </div>
  </div>
</div>

<footer>
</footer>

<style>
  .selected {
    background-color: rgb(199, 225, 241);
  }
</style>

<script>
  config = {
    habitica: {
      id: '',
      token: ''
    },
    trello: {
      token: '',
      member: {
        id: '',
        fullName: '',
        username: '',
        email: '',
        boards: [{
          name: '',
          closed: false,
          id: '',
          lists: [{
            id: '',
            name: ''
          }]
        }]
      },
      using: {
        board: null,
        entryLists: [],
        exitLists: []
      }
    }
  };

  updateTrelloBoards = function () {
    var boards = config.trello.member.boards;

    $('#trello-boards').html('');

    $('#trello-boards').append($('<option/>', {
      class: "trello-board btn-md",
      value: '',
      disabled: true,
      selected: true,
      text: 'Select a Board'
    }));

    if (boards && boards.length) {
      boards.forEach( function (b, i) {
        $("#trello-boards").append($('<option/>', {
          type: 'button',  
          id:'trello-board-' + i,
          class: 'trello-board btn-md',
          text: b.name,
          value: i
        }));
      });
    } else {
      config.trello.using.board = '';
      updateTrelloList();
    }
  };

  $('#trello-boards').on('change', function() {
    var index = this.value;
    var boards = config.trello.member.boards;
    
    config.trello.using.board = config.trello.member.boards[index].id;

    // Fetch lists of board
    var lists = config.trello.member.boards[index].lists;
    if (!lists || !lists.length) {
      window.Trello.boards.get(config.trello.using.board, {
        fields: 'lists',
        lists: 'open'
      }, function (res) {
        config.trello.member.boards[index].lists = res.lists;
        updateTrelloList();
      });
    } else {
      updateTrelloList();
    }

    // Set as selected
    for (var j = 0; j< boards.length; j++ ) {
      $('#trello-board-' + j).removeClass('selected');
    }
    $('#trello-board-' + index).addClass('selected');
  });

  
  
  updateTrelloList = function () {
    var board = config.trello.member.boards.find(function (b) {
      return b.id === config.trello.using.board;
    });

    $('#trello-lists-in').html('');
    $('#trello-lists-out').html('');

    if (board && board.lists && board.lists.length) {
      board.lists.forEach( function (l, i) {
        $("#trello-lists-in").append($('<option>', {
          id: 'trello-list-' + i + '-btn-in',
          type: 'button',
          class: 'trello-list btn-md',
          text: l.name,
          value: board.lists[i].id
        }));
        $("#trello-lists-out").append($('<option>', {
          id: 'trello-list-' + i + '-btn-out',
          type: 'button',
          class: 'trello-list btn-md',
          text: l.name,
          value: board.lists[i].id
        }));
      });
    }
  };
  
  authSuccess = function () {
    config.trello.token = window.Trello.token();
    $('#trello-token').val(config.trello.token);

    window.Trello.members.get('me', {
      fields: 'id,fullName,username,email,avatarUrl',
      boards: 'all'
    }, function (res) {
      $('#trello-login-btn').css("visibility", "hidden");
      config.trello.member = res;
      $('#trello-username').attr({
        src: res.avatarUrl + '/50.png',
        alt: res.username,
        style: "border:2px solid #000000; width: 2.4em",
        'data-toggle': 'tooltip',
        title: res.fullName + ' (' + res.username+ ')'
      });
      updateTrelloBoards();
    });
  };

  authFail = function () {
    config.trello.token = '';
    config.trello.member = {};
    $('#trello-token').val(config.trello.token);
    $('#trello-username').html('');
    updateTrelloBoards();
  };

  $('#trello-login-btn').click(function () {
    window.Trello.authorize({
      type: 'popup',
      name: 'Habitica-Trello Integration',
      persist: false,
      scope: {
        read: true,
        write: true,
        account: true
      },
      expiration: 'never',
      success: authSuccess,
      error: authFail
    });
  });

  $('#create-btn').click(function () {
    config.habitica.id = $('#habitica-id').val();
    config.habitica.token = $('#habitica-token').val();
    
    config.trello.using.exitLists = $("select#trello-lists-out").val();
    config.trello.using.entryLists = $("select#trello-lists-in").val();
    
    // TODO -> send request
    alert('WIP c');
  });
  
  $('#remove-btn').click(function () {
    config.habitica.id = $('#habitica-id').val();
    config.habitica.token = $('#habitica-token').val();

    // TODO -> send request
    alert('WIP');
  });
</script>
</body>