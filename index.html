<!DOCTYPE html>
<html ng-app="trello-habitica" lang="en">
<head>
  <meta charset="utf-8">
  <title ng-bind="pageTitle">
    Trello-Habitica Integration
  </title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>
  <script src="https://api.trello.com/1/client.js?key=db4d00b345825701459f10a434629501"></script>
</head>
<body>

<header>
  <h4>Trello-Habitica Integration</h4>
  <br/>
</header>

<div>
  <div class="habitica">
    <label> Habitica ID:
      <input id="habitica-id" type="text"/>
    </label>
    <label> Habitica API token:
      <input id="habitica-token" type="text"/>
    </label>
  </div>

  <h4>Create integration:</h4>

  <div class="trello">
    <label> Trello token:
      <input id="trello-token" type="text"/>
      <input id="trello-login-btn" type="button" value="Login with Trello"/>
    </label>

    <br/>

    <label> Trello username: </label>
    <input id="trello-username" type="text" disabled>
    
    Trello Boards:
    <div id="trello-boards" class="trello-board-collection">
    </div>
    
    Trello Lists:
    <div id="trello-lists" class="trello-list-collection">
    </div>
  </div>
  <br/>

  <input id="create-btn" type="button" value="create integration"/>
  <input id="remove-btn" type="button" value="remove integration"/>
</div>

<footer>
</footer>

<style>
  .selected {
    background-color: blue;
  }
</style>

<script>
  config = {
    habitica: {
      id: '',
      token: ''
    },
    trello: {
      token: '',
      member: {
        id: '',
        fullName: '',
        username: '',
        boards: [{
          name: '',
          closed: false,
          id: '',
          lists: [{
            id: '',
            name: ''
          }]
        }]
      },
      using: {
        board: null,
        entryLists: [],
        exitLists: []
      }
    }
  };

  updateTrelloBoards = function () {
    var boards = config.trello.member.boards;

    $('#trello-boards').html('');

    if (boards && boards.length) {
      boards.forEach( function (b, i) {
        $("#trello-boards").append($('<input/>', {
          type: 'button',  
          id:'trello-board-' + i,
          class: 'trello-board',
          value: b.name,
          click: function () {
            config.trello.using.board = config.trello.member.boards[i].id;

            // Fetch lists of board
            var lists = config.trello.member.boards[i].lists;
            if (!lists || !lists.length) {
              window.Trello.boards.get(config.trello.using.board, {
                fields: 'lists',
                lists: 'open'
              }, function (res) {
                config.trello.member.boards[i].lists = res.lists;
                updateTrelloList();
              });
            } else {
              updateTrelloList();
            }
            
            // Set as selected
            for (var j = 0; j< boards.length; j++ ) {
              $('#trello-board-' + j).removeClass('selected');
            }
            $('#trello-board-' + i).addClass('selected');
          }
        }));
      });
    } else {
      config.trello.using.board = '';
      updateTrelloList();
    }
  };

  updateTrelloList = function () {
    var board = config.trello.member.boards.find(function (b) {
      return b.id === config.trello.using.board;
    });

    $('#trello-lists').html('');

    if (board && board.lists && board.lists.length) {
      board.lists.forEach( function (l, i) {
        $("#trello-lists").append($('<div>', {
          id: 'trello-list-' + i,
          class: 'trello-list',
          text: l.name
        }).append($('<input/>', {
          id: 'trello-list-' + i + '-btn-in',
          class: 'trello-list-btn trello-list-btn-in',
          type: 'button',
          value: 'in',
          click: function() {
            var lists = config.trello.using.entryLists;
            var index = lists.indexOf(l.id);
            if (index > -1) {
              lists.splice(index, 1);
              $('#trello-list-' + i + '-btn-in').removeClass('selected');
            } else {
              lists.push(l.id);
              $('#trello-list-' + i + '-btn-in').addClass('selected');
            }
          }
        })).append($('<input/>', {
          id: 'trello-list-' + i + '-btn-out',
          class: 'trello-list-btn trello-list-btn-out',
          type: 'button',
          value: 'out',
          click: function() {
            var lists = config.trello.using.exitLists;
            var index = lists.indexOf(l.id);
            if (index > -1) {
              lists.splice(index, 1);
              $('#trello-list-' + i + '-btn-out').removeClass('selected');
            } else {
              lists.push(l.id);
              $('#trello-list-' + i + '-btn-out').addClass('selected');
            }}
        })));
      });
    }
  };
  
  authSuccess = function () {
    config.trello.token = window.Trello.token();
    $('#trello-token').val(config.trello.token);

    window.Trello.members.get('me', {
      fields: 'id,fullName,username',
      boards: 'all'
    }, function (res) {
      config.trello.member = res;
      $('#trello-username').val(config.trello.member.username);
      updateTrelloBoards();
    });
  };

  authFail = function () {
    config.trello.token = '';
    config.trello.member = {};
    $('#trello-token').val(config.trello.token);
    $('#trello-username').val('');
    updateTrelloBoards();
  };

  $('#trello-login-btn').click(function () {
    window.Trello.authorize({
      type: 'popup',
      name: 'Habitica-Trello Integration',
      persist: false,
      scope: {
        read: true,
        write: true,
        account: false
      },
      expiration: 'never',
      success: authSuccess,
      error: authFail
    });
  });

  $('#create-btn').click(function () {
    config.habitica.id = $('#habitica-id').val();
    config.habitica.token = $('#habitica-token').val();
    
    // TODO -> send request
    alert('WIP');
  });
  
  $('#remove-btn').click(function () {
    config.habitica.id = $('#habitica-id').val();
    config.habitica.token = $('#habitica-token').val();

    // TODO -> send request
    alert('WIP');
  });
</script>
</body>